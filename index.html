<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>Nagomi</title>
  <meta name="theme-color" content="#5ED1BF">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Nagomi">
  <link rel="apple-touch-icon" href="/couplesbreath-web/icons/icon-192.png">
  <link rel="manifest" href="manifest.json">
  <style>
    :root{
      --bg:#0b0b0c; --panel:#141417; --text:#eaeaea; --muted:#9aa0a6;
      --accent:#2563eb; --danger:#ef4444; --border:#2a2a2e;
    }
    *{ box-sizing:border-box; }
    html,body{
      height:100%; margin:0;
      background:linear-gradient(170deg,#1B2838 0%,#1E3141 30%,#1A2C3D 60%,#162231 100%);
      color:var(--text);
      font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,Apple Color Emoji,Segoe UI Emoji;
    }

    /* ── Idle screen ── */
    #idleScreen{
      min-height:100vh;
      display:flex; flex-direction:column; align-items:center;
      padding:16px;
      padding-bottom:max(24px,env(safe-area-inset-bottom));
    }

    /* Status pills row */
    .status-pills{
      display:flex; gap:8px; flex-wrap:wrap; justify-content:center;
      width:100%; max-width:720px; margin-bottom:auto;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px; padding:6px 10px;
      border-radius:999px; background:rgba(20,20,23,0.55);
      border:1px solid var(--border); color:var(--muted); font-size:13px; white-space:nowrap;
    }
    .pill strong{ color:var(--text); font-weight:600; }

    /* Center content */
    .idle-center{
      flex:1;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
    }
    #idleTitle{
      font-size:32px; font-weight:500; color:#E8F0F2;
      letter-spacing:2px; text-align:center;
      font-family:-apple-system,'SF Pro Display','Helvetica Neue',system-ui,sans-serif;
    }
    #idleTagline{
      font-size:16px; color:#93B8CA; text-align:center;
      margin-top:8px; margin-bottom:32px;
      font-family:-apple-system,'SF Pro Display','Helvetica Neue',system-ui,sans-serif;
    }
    #idlePetalWrap{
      position:relative; width:200px; height:200px;
      display:flex; align-items:center; justify-content:center;
    }
    #idlePetalRoot{
      position:relative; width:200px; height:200px;
    }

    /* Bottom area */
    .idle-bottom{
      display:flex; flex-direction:column; align-items:center;
      gap:12px; padding-top:32px;
    }

    /* ── Toggle button ── */
    #btnToggle{
      width:220px;
      padding:16px 48px;
      border-radius:14px;
      font-size:15px; font-weight:500;
      background:rgba(94,209,191,0.12);
      border:1px solid rgba(94,209,191,0.3);
      color:#5ED1BF;
      cursor:pointer;
      font-family:-apple-system,'SF Pro Display','Helvetica Neue',system-ui,sans-serif;
      transition:background .15s ease,border-color .15s ease,color .15s ease;
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      touch-action:manipulation; position:relative;
    }
    #btnToggle.btn-active{
      background:rgba(255,107,107,0.12);
      border-color:rgba(255,107,107,0.3);
      color:#FF6B6B;
    }
    #btnToggle:active{ transform:scale(0.98); }
    #btnToggle[disabled].is-busy{ opacity:.85; }
    #btnToggle[disabled].is-busy::after{
      content:""; position:absolute; right:14px; top:50%; width:14px; height:14px;
      margin-top:-7px; border-radius:50%;
      border:2px solid rgba(255,255,255,0.6); border-top-color:transparent;
      animation:spin .8s linear infinite;
    }
    @keyframes spin{ to{ transform:rotate(360deg); } }

    /* Pulsing dot for active state */
    @keyframes bPulseDot{ 0%,100%{transform:scale(1);opacity:1} 50%{transform:scale(1.3);opacity:0.5} }
    .rec-pulse-dot{
      display:inline-block; width:8px; height:8px; border-radius:50%;
      background:#FF6B6B; flex-shrink:0;
      animation:bPulseDot 1.5s ease-in-out infinite;
    }

    /* Recording status bar */
    #recStatusBar{
      font-size:13px; font-weight:500; letter-spacing:0.3px;
      display:flex; align-items:center; justify-content:center; gap:6px;
      padding:6px 16px; border-radius:8px;
      transition:background .25s ease,color .25s ease;
    }
    #recStatusBar.rec-active{ background:rgba(94,209,191,0.10); color:#5ED1BF; }
    #recStatusBar.rec-inactive{ background:transparent; color:#9aa0a6; }
    @keyframes bStatusDot{ 0%,100%{opacity:1} 50%{opacity:0.35} }
    .status-dot-active{ animation:bStatusDot 1.5s ease-in-out infinite; }

    /* rec-dot mic level indicator */
    .rec-dot{
      display:inline-block; width:10px; height:10px; margin-left:6px; border-radius:50%;
      background:#666; box-shadow:0 0 0 rgba(255,0,0,0);
      transition:background .15s ease,box-shadow .15s ease,transform .15s ease;
    }
    .rec-hot{ background:#ef4444; box-shadow:0 0 10px rgba(239,68,68,0.55); transform:scale(1.1); }

    /* ── Pause shimmer ── */
    @keyframes bShimmer{
      0%,100%{ color:#E8F0F2; text-shadow:none; }
      50%{ color:rgba(94,209,191,0.9); text-shadow:0 0 20px rgba(94,209,191,0.4); }
    }
    @keyframes bShimmerSub{
      0%,100%{ opacity:0.6; }
      50%{ opacity:1.0; }
    }
    .b-shimmer{ animation:bShimmer 2.5s ease-in-out infinite; }
    .b-shimmer-sub{ animation:bShimmerSub 2.5s ease-in-out 0.4s infinite; }
  </style>
</head>
<body>
<div id="idleScreen">
  <!-- Status pills -->
  <div class="status-pills">
    <div class="pill"><strong id="pillMode">mode: —</strong></div>
    <div class="pill">status: <strong id="vStatus">idle</strong></div>
    <div class="pill">mic: <strong id="vMic">off</strong></div>
    <div class="pill">server: <strong id="vServer">—</strong></div>
    <div class="pill">rec:<strong><span class="rec-dot" id="recDot"></span></strong></div>
  </div>

  <!-- Centre: title + tagline + idle petals -->
  <div class="idle-center">
    <div id="idleTitle">Nagomi</div>
    <div id="idleTagline">Together as one</div>
    <div id="idlePetalWrap">
      <div id="idlePetalRoot"></div>
    </div>
  </div>

  <!-- Bottom: toggle + status -->
  <div class="idle-bottom">
    <button id="btnToggle" type="button">Start Session</button>
    <div id="recStatusBar" class="rec-inactive"><span style="font-size:10px;">○</span> Not recording</div>
  </div>
</div>

<!-- Breath overlay built by buildBreathOverlay() at startup -->

<script>
// ─── CONFIG ──────────────────────────────────────────────────────────────────
const OVERLAY_DURATION = 20;
const BREATH_PATTERN   = [4,4,4,4]; // [inhale, hold1, exhale, hold2]
const qs     = new URLSearchParams(location.search);
const WS_URL = qs.get('ws') || 'wss://pause-proxy.onrender.com/client';
const DEBUG  = qs.has('debug');
const CHUNK_MS = 1000;
let mediaStream, audioCtx, processor, micSource, ws;

// ─── GENTLE BELL ─────────────────────────────────────────────────────────────
function playGentleBell() {
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  const duration = 4.0;
  const freq = 480; // Brighter, clearer
  
  // Fundamental + harmonics (singing bowl)
  const fundamental = audioCtx.createOscillator();
  const harmonic1 = audioCtx.createOscillator();
  const harmonic2 = audioCtx.createOscillator();
  
  fundamental.frequency.value = freq;
  harmonic1.frequency.value = freq * 1.5;
  harmonic2.frequency.value = freq * 2.0;
  
  fundamental.type = 'sine';
  harmonic1.type = 'sine';
  harmonic2.type = 'sine';
  
  const fundamentalGain = audioCtx.createGain();
  const harmonic1Gain = audioCtx.createGain();
  const harmonic2Gain = audioCtx.createGain();
  const masterGain = audioCtx.createGain();
  
  fundamental.connect(fundamentalGain);
  harmonic1.connect(harmonic1Gain);
  harmonic2.connect(harmonic2Gain);
  fundamentalGain.connect(masterGain);
  harmonic1Gain.connect(masterGain);
  harmonic2Gain.connect(masterGain);
  masterGain.connect(audioCtx.destination);
  
  fundamentalGain.gain.value = 1.0;
  harmonic1Gain.gain.value = 0.3;
  harmonic2Gain.gain.value = 0.15;
  
  const now = audioCtx.currentTime;
  
  // Soft attack + decay
  masterGain.gain.setValueAtTime(0, now);
  masterGain.gain.linearRampToValueAtTime(0.10, now + 0.15);
  masterGain.gain.exponentialRampToValueAtTime(0.001, now + duration);
  
  fundamental.start(now);
  harmonic1.start(now);
  harmonic2.start(now);
  
  fundamental.stop(now + duration);
  harmonic1.stop(now + duration);
  harmonic2.stop(now + duration);
}

// ─── OM SOUND ────────────────────────────────────────────────────────────────
function playOmSound() {
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  const duration = 3.0;
  const freq = 136; // Traditional Om frequency
  
  // Fundamental + harmonics for richness
  const fundamental = audioCtx.createOscillator();
  const harmonic1 = audioCtx.createOscillator();
  const harmonic2 = audioCtx.createOscillator();
  
  fundamental.frequency.value = freq;
  harmonic1.frequency.value = freq * 2.0;
  harmonic2.frequency.value = freq * 3.0;
  
  fundamental.type = 'sine';
  harmonic1.type = 'sine';
  harmonic2.type = 'sine';
  
  const fundamentalGain = audioCtx.createGain();
  const harmonic1Gain = audioCtx.createGain();
  const harmonic2Gain = audioCtx.createGain();
  const masterGain = audioCtx.createGain();
  
  fundamental.connect(fundamentalGain);
  harmonic1.connect(harmonic1Gain);
  harmonic2.connect(harmonic2Gain);
  fundamentalGain.connect(masterGain);
  harmonic1Gain.connect(masterGain);
  harmonic2Gain.connect(masterGain);
  masterGain.connect(audioCtx.destination);
  
  fundamentalGain.gain.value = 1.0;
  harmonic1Gain.gain.value = 0.4;
  harmonic2Gain.gain.value = 0.2;
  
  const now = audioCtx.currentTime;
  
  // Soft attack + long sustain + gentle fade
  masterGain.gain.setValueAtTime(0, now);
  masterGain.gain.linearRampToValueAtTime(0.08, now + 0.2);
  masterGain.gain.exponentialRampToValueAtTime(0.001, now + duration);
  
  fundamental.start(now);
  harmonic1.start(now);
  harmonic2.start(now);
  
  fundamental.stop(now + duration);
  harmonic1.stop(now + duration);
  harmonic2.stop(now + duration);
}

// ─── WAV ENCODER (untouched) ─────────────────────────────────────────────────
function pcm16leToWavBase64(float32, sampleRate){
  const numChannels=1,bytesPerSample=2,blockAlign=numChannels*bytesPerSample;
  const byteRate=sampleRate*blockAlign,dataLength=float32.length*bytesPerSample;
  const buffer=new ArrayBuffer(44+dataLength),view=new DataView(buffer);
  let o=0;
  function wstr(s){for(let i=0;i<s.length;i++)view.setUint8(o++,s.charCodeAt(i));}
  function w16(v){view.setUint16(o,v,true);o+=2;}
  function w32(v){view.setUint32(o,v,true);o+=4;}
  wstr('RIFF');w32(36+dataLength);wstr('WAVE');wstr('fmt ');w32(16);w16(1);
  w16(numChannels);w32(sampleRate);w32(byteRate);w16(blockAlign);w16(16);
  wstr('data');w32(dataLength);
  const out=new Int16Array(buffer,44,float32.length);
  for(let i=0;i<float32.length;i++){let s=Math.max(-1,Math.min(1,float32[i]));out[i]=s<0?s*0x8000:s*0x7FFF;}
  let bin='';const bytes=new Uint8Array(buffer);for(let i=0;i<bytes.length;i++)bin+=String.fromCharCode(bytes[i]);
  return btoa(bin);
}

// ─── DEBUG STATE ─────────────────────────────────────────────────────────────
const debugState = {
  hyperScore:     0,
  humeStatus:     'disconnected',
  lastResponseAt: null,
};

// ─── DOM HELPERS ─────────────────────────────────────────────────────────────
function byId(id){ return document.getElementById(id); }
const pillMode=byId('pillMode'),vStatus=byId('vStatus'),vMic=byId('vMic'),vServer=byId('vServer');
const btnToggle=byId('btnToggle'),recDot=byId('recDot');
function setStatus(s){ vStatus.textContent=s; }
function setMic(s)   { vMic.textContent=s; }
function setServer(s){ vServer.textContent=s; }
function setMode(m)  { pillMode.textContent='mode: '+m; }

// ═══════════════════════════════════════════════════════════════════════════════
//  BREATH-V9 — vanilla JS port
//  Ported from breath-v9.jsx. No React, no build step, pure DOM + rAF.
// ═══════════════════════════════════════════════════════════════════════════════

const B_FONT = "-apple-system,'SF Pro Display','Helvetica Neue',system-ui,sans-serif";
const B_BG   = "linear-gradient(170deg,#1B2838 0%,#1E3141 30%,#1A2C3D 60%,#162231 100%)";
const B_TYPE = {
  title:    {fontSize:'26px',fontWeight:'500',color:'#E8F0F2',letterSpacing:'0.5px'},
  subtitle: {fontSize:'16px',fontWeight:'400',color:'#93B8CA'},
  count:    {fontSize:'48px',fontWeight:'200',color:'rgba(225,238,242,0.55)'},
  meta:     {fontSize:'13px',fontWeight:'400',color:'#5A8A9E',letterSpacing:'1.5px'},
};

const B_PATTERNS = {
  "4-4-6":   {inhale:4,hold1:4,exhale:6,hold2:0},
  "4-4-4-4": {inhale:4,hold1:4,exhale:4,hold2:4},
  "4-7-8":   {inhale:4,hold1:7,exhale:8,hold2:0},
};
const B_PHASES      = ["inhale","hold1","exhale","hold2"];
const B_PHASE_LABELS= {inhale:"Inhale",hold1:"Hold",exhale:"Exhale",hold2:"Hold"};
const B_COMPLETION  = [
  "You reset, together",
  "Back in sync",
  "Beautiful reset",
  "You slowed down, together",
];

// Petal constants
const PETAL_COUNT      = 6;
const PETAL_COLORS     = [
  "rgba(94,209,191,0.50)","rgba(72,191,227,0.45)","rgba(129,212,172,0.45)",
  "rgba(94,209,191,0.40)","rgba(72,191,227,0.40)","rgba(129,212,172,0.45)",
];
const PETAL_MIN_SPREAD = 0.22;
const PETAL_MAX_SPREAD = 1.0;
const PETAL_MIN_SCALE  = 0.7;
const PETAL_MAX_SCALE  = 1.0;

// Mutable breath state
const breathState = {
  animFrame:       null,
  pauseStartTime:  null,
  breathStartTime: null,
  duration:        OVERLAY_DURATION,
  pattern:         {inhale:4,hold1:4,exhale:4,hold2:4},
  completionCount: 0,
};

// ─── Idle petal state ─────────────────────────────────────────────────────────
let idleRafId    = null;
let idleRotation = 0;
let idleLastTime = null;

// ─── buildIdlePetals ──────────────────────────────────────────────────────────
// Creates the petal DOM nodes inside #idlePetalRoot. Called once at startup.
function buildIdlePetals(){
  const root = byId('idlePetalRoot');
  if(!root) return;
  const SIZE = 200, PPX = SIZE * 0.42;

  const glow = document.createElement('div');
  glow.id = 'idleGlow';
  Object.assign(glow.style,{position:'absolute',inset:'-30px',borderRadius:'50%',
    background:'radial-gradient(circle,rgba(94,209,191,0.08) 0%,transparent 65%)',
    filter:'blur(30px)',pointerEvents:'none'});
  root.appendChild(glow);

  for(let i=0;i<PETAL_COUNT;i++){
    const p = document.createElement('div');
    p.id = 'idlePetal'+i;
    Object.assign(p.style,{position:'absolute',width:PPX+'px',height:PPX+'px',borderRadius:'50%',
      background:PETAL_COLORS[i],left:'50%',top:'50%',
      marginLeft:(-PPX/2)+'px',marginTop:(-PPX/2)+'px',filter:'blur(1px)'});
    root.appendChild(p);
  }
}

// ─── updateIdlePetals ─────────────────────────────────────────────────────────
function updateIdlePetals(scale, rotation){
  const size = 200;
  const spread = (PETAL_MIN_SPREAD+(PETAL_MAX_SPREAD-PETAL_MIN_SPREAD)*scale)*(size*0.2);
  const ps = PETAL_MIN_SCALE+(PETAL_MAX_SCALE-PETAL_MIN_SCALE)*scale;
  for(let i=0;i<PETAL_COUNT;i++){
    const a=(i*360/PETAL_COUNT)+rotation, r=(a*Math.PI)/180;
    const el=byId('idlePetal'+i);
    if(el) el.style.transform=`translate(${Math.cos(r)*spread}px,${Math.sin(r)*spread}px) scale(${ps})`;
  }
  const g=byId('idleGlow');
  if(g) g.style.transform=`scale(${0.7+scale*0.5})`;
}

// ─── Idle rAF loop — 4°/sec rotation ─────────────────────────────────────────
function idlePetalTick(now){
  if(idleLastTime===null) idleLastTime=now;
  const dt=(now-idleLastTime)/1000;
  idleLastTime=now;
  idleRotation+=4*dt;
  updateIdlePetals(0.45, idleRotation);
  idleRafId=requestAnimationFrame(idlePetalTick);
}

function startIdlePetal(){
  if(idleRafId) return;
  idleLastTime=null;
  idleRafId=requestAnimationFrame(idlePetalTick);
}

function stopIdlePetal(){
  if(idleRafId){ cancelAnimationFrame(idleRafId); idleRafId=null; idleLastTime=null; }
}

// ─── buildBreathOverlay ───────────────────────────────────────────────────────
function buildBreathOverlay(){
  const kf=document.createElement('style');
  kf.textContent='@keyframes bSoftIn{0%{opacity:0;transform:translateY(8px)}100%{opacity:1;transform:translateY(0)}}';
  document.head.appendChild(kf);

  const ov=document.createElement('div');
  ov.id='breathOverlay';
  Object.assign(ov.style,{position:'fixed',inset:'0',zIndex:'50',display:'none',background:B_BG,fontFamily:B_FONT});

  // ── ACTIVE SCREEN ──────────────────────────────────────────────────────────
  const active=document.createElement('div');
  active.id='bActiveScreen';
  Object.assign(active.style,{position:'absolute',inset:'0',display:'flex',
    flexDirection:'column',alignItems:'center',justifyContent:'center'});

  const tz=document.createElement('div');
  Object.assign(tz.style,{position:'relative',width:'300px',height:'56px',marginBottom:'2px'});

  const pg=document.createElement('div');
  pg.id='bPauseGrp';
  Object.assign(pg.style,{position:'absolute',inset:'0',display:'flex',flexDirection:'column',
    alignItems:'center',justifyContent:'flex-start',opacity:'0',pointerEvents:'none'});
  const pt=document.createElement('span');
  pt.id='bPauseTitle';
  Object.assign(pt.style,{...B_TYPE.title,fontFamily:B_FONT,lineHeight:'30px'});
  pt.textContent="Let's pause";
  const ps2=document.createElement('span');
  ps2.id='bPauseSubtitle';
  Object.assign(ps2.style,{...B_TYPE.subtitle,fontFamily:B_FONT,marginTop:'6px',lineHeight:'20px'});
  ps2.textContent="Take this moment together";
  pg.append(pt,ps2);

  const bg2=document.createElement('div');
  bg2.id='bBreathGrp';
  Object.assign(bg2.style,{position:'absolute',inset:'0',display:'flex',flexDirection:'column',
    alignItems:'center',justifyContent:'flex-start',opacity:'0',pointerEvents:'none'});
  const bl=document.createElement('span');
  bl.id='bPhaseLabel';
  Object.assign(bl.style,{...B_TYPE.title,fontFamily:B_FONT,lineHeight:'30px'});
  bl.textContent='Inhale';
  const bsp=document.createElement('span');
  Object.assign(bsp.style,{...B_TYPE.subtitle,fontFamily:B_FONT,marginTop:'6px',lineHeight:'20px',opacity:'0'});
  bsp.innerHTML='&nbsp;';
  bg2.append(bl,bsp);
  tz.append(pg,bg2);

  const pa=document.createElement('div');
  Object.assign(pa.style,{position:'relative',width:'220px',height:'220px',display:'flex',
    alignItems:'center',justifyContent:'center'});

  const pr=document.createElement('div');
  pr.id='bPetalsRoot';
  Object.assign(pr.style,{position:'relative',width:'220px',height:'220px'});

  const glow=document.createElement('div');
  glow.id='bGlow';
  Object.assign(glow.style,{position:'absolute',inset:'-30px',borderRadius:'50%',
    background:'radial-gradient(circle,rgba(94,209,191,0.08) 0%,transparent 65%)',
    filter:'blur(30px)',pointerEvents:'none'});
  pr.appendChild(glow);

  const PPX=220*0.42;
  for(let i=0;i<PETAL_COUNT;i++){
    const p=document.createElement('div');
    p.id='bPetal'+i;
    Object.assign(p.style,{position:'absolute',width:PPX+'px',height:PPX+'px',borderRadius:'50%',
      background:PETAL_COLORS[i],left:'50%',top:'50%',
      marginLeft:(-PPX/2)+'px',marginTop:(-PPX/2)+'px',filter:'blur(1px)'});
    pr.appendChild(p);
  }
  pa.appendChild(pr);

  const ce=document.createElement('div');
  ce.id='bCount';
  Object.assign(ce.style,{position:'absolute',inset:'0',display:'flex',alignItems:'center',
    justifyContent:'center',zIndex:'2',opacity:'0',
    ...B_TYPE.count,fontVariantNumeric:'tabular-nums',fontFamily:B_FONT});
  ce.textContent='1';
  pa.appendChild(ce);

  const re=document.createElement('div');
  re.id='bRemaining';
  Object.assign(re.style,{marginTop:'14px',height:'18px',...B_TYPE.meta,fontFamily:B_FONT,
    opacity:'0',fontVariantNumeric:'tabular-nums',display:'flex',alignItems:'center',justifyContent:'center'});
  re.textContent='\u00A0';

  const ew=document.createElement('div');
  Object.assign(ew.style,{position:'absolute',bottom:'8%',left:'0',right:'0',textAlign:'center'});
  const eb=document.createElement('button');
  eb.textContent='End';
  Object.assign(eb.style,{padding:'12px 36px',borderRadius:'999px',
    border:'1px solid rgba(94,209,191,0.15)',background:'rgba(94,209,191,0.08)',
    color:'#7FA8BE',fontSize:'14px',fontWeight:'500',cursor:'pointer',
    letterSpacing:'1px',fontFamily:B_FONT});
  eb.addEventListener('click',hideBreathOverlay);
  ew.appendChild(eb);

  active.append(tz,pa,re,ew);

  // ── DONE SCREEN ────────────────────────────────────────────────────────────
  const done=document.createElement('div');
  done.id='bDoneScreen';
  Object.assign(done.style,{position:'absolute',inset:'0',display:'none',
    flexDirection:'column',alignItems:'center',justifyContent:'center'});

  const dpw=document.createElement('div');
  Object.assign(dpw.style,{marginBottom:'20px',transform:'scale(0.45)',height:'100px',
    display:'flex',alignItems:'center',justifyContent:'center'});
  const dpr=document.createElement('div');
  Object.assign(dpr.style,{position:'relative',width:'200px',height:'200px'});

  const DS=200,DPXS=DS*0.42,DSCL=0.4,DROT=30;
  const DM=PETAL_MIN_SPREAD+(PETAL_MAX_SPREAD-PETAL_MIN_SPREAD)*DSCL;
  const DSP=DM*(DS*0.2);
  const DPS=PETAL_MIN_SCALE+(PETAL_MAX_SCALE-PETAL_MIN_SCALE)*DSCL;
  const dg=document.createElement('div');
  Object.assign(dg.style,{position:'absolute',inset:'-30px',borderRadius:'50%',
    background:'radial-gradient(circle,rgba(94,209,191,0.08) 0%,transparent 65%)',
    filter:'blur(30px)',transform:`scale(${0.7+DSCL*0.5})`});
  dpr.appendChild(dg);
  for(let i=0;i<PETAL_COUNT;i++){
    const a=(i*360/PETAL_COUNT)+DROT,r=(a*Math.PI)/180;
    const dp2=document.createElement('div');
    Object.assign(dp2.style,{position:'absolute',width:DPXS+'px',height:DPXS+'px',borderRadius:'50%',
      background:PETAL_COLORS[i],left:'50%',top:'50%',
      marginLeft:(-DPXS/2)+'px',marginTop:(-DPXS/2)+'px',
      transform:`translate(${Math.cos(r)*DSP}px,${Math.sin(r)*DSP}px) scale(${DPS})`,
      filter:'blur(1px)'});
    dpr.appendChild(dp2);
  }
  dpw.appendChild(dpr);

  const dm=document.createElement('div');
  dm.id='bDoneMsg';
  Object.assign(dm.style,{...B_TYPE.title,fontFamily:B_FONT});

  const ds2=document.createElement('div');
  Object.assign(ds2.style,{...B_TYPE.subtitle,fontFamily:B_FONT,marginTop:'6px',marginBottom:'40px',
    maxWidth:'280px',textAlign:'center',lineHeight:'1.6'});
  ds2.textContent="Return to your conversation whenever you're ready";

  const db=document.createElement('button');
  db.textContent='Done';
  Object.assign(db.style,{padding:'12px 36px',borderRadius:'999px',
    border:'1px solid rgba(94,209,191,0.15)',background:'rgba(94,209,191,0.08)',
    color:'#7FA8BE',fontSize:'14px',fontWeight:'500',cursor:'pointer',
    letterSpacing:'1px',fontFamily:B_FONT});
  db.addEventListener('click',hideBreathOverlay);

  done.append(dpw,dm,ds2,db);
  ov.append(active,done);
  document.body.appendChild(ov);
}

// ─── updatePetals ─────────────────────────────────────────────────────────────
function updatePetals(scale,rotation){
  const size=220;
  const spread=(PETAL_MIN_SPREAD+(PETAL_MAX_SPREAD-PETAL_MIN_SPREAD)*scale)*(size*0.2);
  const ps=PETAL_MIN_SCALE+(PETAL_MAX_SCALE-PETAL_MIN_SCALE)*scale;
  for(let i=0;i<PETAL_COUNT;i++){
    const a=(i*360/PETAL_COUNT)+rotation,r=(a*Math.PI)/180;
    const el=byId('bPetal'+i);
    if(el) el.style.transform=`translate(${Math.cos(r)*spread}px,${Math.sin(r)*spread}px) scale(${ps})`;
  }
  const g=byId('bGlow');
  if(g) g.style.transform=`scale(${0.7+scale*0.5})`;
}

// ─── breathTick ───────────────────────────────────────────────────────────────
function breathTick(now){
  if(!breathState.pauseStartTime) breathState.pauseStartTime=now;
  const te=(now-breathState.pauseStartTime)/1000;
  const PAUSE_DUR=7.0,XFADE_START=5.5,XFADE_LEN=1.2;

  const pg=byId('bPauseGrp'),bg2=byId('bBreathGrp');
  const ce=byId('bCount'),re=byId('bRemaining'),bl=byId('bPhaseLabel');
  const bpt=byId('bPauseTitle'),bps=byId('bPauseSubtitle');

  if(te<PAUSE_DUR){
    updatePetals(Math.max(0,Math.sin(te*1.2)*0.06),te*5);
    let po,bo;
    if(te<XFADE_START){
      po=Math.min(1,te/0.7); bo=0;
      if(bpt && !bpt.classList.contains('b-shimmer')) bpt.classList.add('b-shimmer');
      if(bps && !bps.classList.contains('b-shimmer-sub')) bps.classList.add('b-shimmer-sub');
    } else {
      if(bpt) bpt.classList.remove('b-shimmer');
      if(bps) bps.classList.remove('b-shimmer-sub');
      const cf=(te-XFADE_START)/XFADE_LEN;
      po=Math.max(0,1-cf*1.2); bo=Math.min(1,cf);
    }
    if(pg)  pg.style.opacity=po;
    if(bg2) bg2.style.opacity=bo;
    if(ce)  ce.style.opacity=bo;
    if(re)  re.style.opacity=bo;
    breathState.animFrame=requestAnimationFrame(breathTick);
    return;
  }
  if(bpt) bpt.classList.remove('b-shimmer');
  if(bps) bps.classList.remove('b-shimmer-sub');

  if(pg)  pg.style.opacity=0;
  if(bg2) bg2.style.opacity=1;
  if(ce)  ce.style.opacity=1;

  if(!breathState.breathStartTime) breathState.breathStartTime=now;
  const be=(now-breathState.breathStartTime)/1000;
  const remaining=Math.max(0,breathState.duration-be);

  if(remaining<=0){
    breathState.completionCount++;
    showBreathDoneScreen();
    return;
  }

  if(re){ re.style.opacity=1; re.textContent=Math.ceil(remaining)+'s remaining'; }

  const pat=breathState.pattern;
  const cycleLen=pat.inhale+pat.hold1+pat.exhale+(pat.hold2||0);
  const cp=be%cycleLen;
  let phase='inhale',progress=0,count=1,cum=0;
  for(const p of B_PHASES){
    const d=pat[p]||0; if(!d) continue;
    if(cp<cum+d){
      const into=cp-cum;
      progress=into/d;
      count=Math.min(Math.floor(into)+1,d);
      phase=p; break;
    }
    cum+=d;
  }

  let ts;
  switch(phase){
    case 'inhale': ts=progress;   break;
    case 'hold1':  ts=1;          break;
    case 'exhale': ts=1-progress; break;
    default:       ts=0;
  }
  updatePetals(ts,(PAUSE_DUR+be)*6);
  if(bl) bl.textContent=B_PHASE_LABELS[phase];
  if(ce) ce.textContent=count;

  breathState.animFrame=requestAnimationFrame(breathTick);
}

// ─── showBreathDoneScreen ────────────────────────────────────────────────────
function showBreathDoneScreen(){
  const a=byId('bActiveScreen'),d=byId('bDoneScreen'),m=byId('bDoneMsg');
  if(a) a.style.display='none';
  if(d){
    d.style.display='flex';
    d.style.animation='none';
    void d.offsetWidth;
    d.style.animation='bSoftIn 1s ease forwards';
  }
  if(m) m.textContent=B_COMPLETION[(breathState.completionCount-1)%B_COMPLETION.length];
}

// ─── hideBreathOverlay ───────────────────────────────────────────────────────
function hideBreathOverlay(){
  playOmSound();
  if(breathState.animFrame){ cancelAnimationFrame(breathState.animFrame); breathState.animFrame=null; }
  const bpt=byId('bPauseTitle'),bps=byId('bPauseSubtitle');
  if(bpt) bpt.classList.remove('b-shimmer');
  if(bps) bps.classList.remove('b-shimmer-sub');
  const ov=byId('breathOverlay');
  if(ov) ov.style.display='none';
  breathState.pauseStartTime=null;
  breathState.breathStartTime=null;
  updateRecordingUI();
  startIdlePetal(); // resume idle petal rotation
}

// ─── showOverlay ─────────────────────────────────────────────────────────────
function showOverlay(seconds=OVERLAY_DURATION,pattern=BREATH_PATTERN){
  if (navigator.vibrate) navigator.vibrate(200);
  playGentleBell();
  if(breathState.animFrame){ cancelAnimationFrame(breathState.animFrame); breathState.animFrame=null; }
  stopIdlePetal(); // pause idle rotation while overlay is active

  if(Array.isArray(pattern)){
    breathState.pattern={inhale:pattern[0]??4,hold1:pattern[1]??4,exhale:pattern[2]??4,hold2:pattern[3]??0};
  } else {
    breathState.pattern=pattern;
  }
  breathState.duration=seconds;
  breathState.pauseStartTime=null;
  breathState.breathStartTime=null;

  const ov=byId('breathOverlay'),a=byId('bActiveScreen'),d=byId('bDoneScreen');
  if(ov) ov.style.display='flex';
  if(a)  a.style.display='flex';
  if(d)  d.style.display='none';

  const pg=byId('bPauseGrp'),bg2=byId('bBreathGrp'),ce=byId('bCount'),re=byId('bRemaining');
  if(pg)  pg.style.opacity=0;
  if(bg2) bg2.style.opacity=0;
  if(ce){ ce.style.opacity=0; ce.textContent='1'; }
  if(re){ re.style.opacity=0; re.textContent='\u00A0'; }
  updatePetals(0,0);

  breathState.animFrame=requestAnimationFrame(breathTick);
}

// ─── Recording state ─────────────────────────────────────────────────────────
let isRecording = false;

function updateRecordingUI(){
  const sb = byId('recStatusBar');
  if(isRecording){
    btnToggle.classList.add('btn-active');
    btnToggle.innerHTML = '<span class="rec-pulse-dot"></span>Stop Session';
    if(sb){
      sb.className = 'rec-active';
      sb.innerHTML = '<span class="status-dot-active" style="font-size:10px;">●</span> Recording active';
    }
  } else {
    btnToggle.classList.remove('btn-active');
    btnToggle.textContent = 'Start Session';
    if(sb){
      sb.className = 'rec-inactive';
      sb.innerHTML = '<span style="font-size:10px;">○</span> Not recording';
    }
  }
}

// ─── tapFeedback ─────────────────────────────────────────────────────────────
function tapFeedback(el){ el.style.transform='scale(0.98)'; setTimeout(()=>{ el.style.transform=''; },120); }

// ─── WebSocket ───────────────────────────────────────────────────────────────
function connectWS(){
  if(ws&&(ws.readyState===WebSocket.OPEN||ws.readyState===WebSocket.CONNECTING)) return;
  ws=new WebSocket(WS_URL);
  setServer('connecting');
  debugState.humeStatus='connecting';

  ws.onopen=()=>{ setServer('connected'); debugState.humeStatus='connected'; };
  ws.onerror=()=>{ setServer('error'); debugState.humeStatus='error'; };
  ws.onclose=()=>{
    setServer('closed');
    debugState.humeStatus='disconnected';
    if(vStatus.textContent==='listening') setTimeout(()=>connectWS(),1000);
  };
  ws.onmessage=(ev)=>{
    let msg; try{ msg=JSON.parse(ev.data); } catch{ return; }
    if(msg.type==='hello'){
      setMode(msg.mode||'hume');
    } else if(msg.type==='risk'){
      // Ongoing risk updates from backend
      setServer(msg.status||'—');
      if(msg.hyper!=null) debugState.hyperScore=msg.hyper;
      debugState.lastResponseAt=Date.now();
    } else if(msg.type==='trigger'){
      // Trigger event (threshold crossed)
      if(msg.kind==='hyper'){
        if(msg.score!=null) debugState.hyperScore=msg.score;
        debugState.lastResponseAt=Date.now();
        showOverlay(OVERLAY_DURATION,BREATH_PATTERN);
      }
    }
  };
}

// ─── start ───────────────────────────────────────────────────────────────────
async function start(){
  tapFeedback(btnToggle);
  setStatus('starting…');
  btnToggle.disabled=true; btnToggle.classList.add('is-busy');
  connectWS();
  mediaStream=await navigator.mediaDevices.getUserMedia({audio:true});
  setMic('on');
  audioCtx=new (window.AudioContext||window.webkitAudioContext)({sampleRate:48000});
  micSource=audioCtx.createMediaStreamSource(mediaStream);
  const BUFFER_SIZE=4096;
  processor=audioCtx.createScriptProcessor(BUFFER_SIZE,1,1);
  const chunk=[];
  let lastSent=performance.now();
  processor.onaudioprocess=(e)=>{
    const input=e.inputBuffer.getChannelData(0);
    let sum=0; for(let i=0;i<input.length;i++) sum+=input[i]*input[i];
    const rms=Math.sqrt(sum/input.length);
    if(recDot){ if(rms>0.017) recDot.classList.add('rec-hot'); else recDot.classList.remove('rec-hot'); }
    const copy=new Float32Array(input.length); copy.set(input); chunk.push(copy);
    const now=performance.now();
    if(now-lastSent>=CHUNK_MS){
      const total=chunk.reduce((s,a)=>s+a.length,0);
      const joined=new Float32Array(total);
      let o=0; for(const buf of chunk){ joined.set(buf,o); o+=buf.length; }
      chunk.length=0;
      const b64=pcm16leToWavBase64(joined,audioCtx.sampleRate);
      if(ws&&ws.readyState===WebSocket.OPEN){ try{ ws.send(JSON.stringify({type:'audio',data_b64:b64})); }catch{} }
      lastSent=now;
    }
  };
  micSource.connect(processor);
  processor.connect(audioCtx.destination);
  btnToggle.classList.remove('is-busy');
  btnToggle.disabled=false;
  setStatus('listening');
  isRecording=true; updateRecordingUI();
}

// ─── stop ────────────────────────────────────────────────────────────────────
async function stop(){
  tapFeedback(btnToggle);
  setStatus('stopping…');
  btnToggle.disabled=true; btnToggle.classList.add('is-busy');
  try{ if(processor) processor.disconnect(); }catch{}
  try{ if(micSource) micSource.disconnect(); }catch{}
  try{ if(audioCtx) await audioCtx.close(); }catch{}
  try{ if(mediaStream) mediaStream.getTracks().forEach(t=>t.stop()); }catch{}
  mediaStream=null; audioCtx=null; processor=null; micSource=null;
  setMic('off'); setStatus('idle');
  btnToggle.classList.remove('is-busy');
  btnToggle.disabled=false;
  isRecording=false; updateRecordingUI();
}

// Single toggle handler
btnToggle.addEventListener('click', ()=>{ if(isRecording) stop(); else start(); });

// ─── INIT ────────────────────────────────────────────────────────────────────
buildBreathOverlay();
buildIdlePetals();
updateRecordingUI();
startIdlePetal();   // begin slow petal rotation on load
connectWS();

// ═══════════════════════════════════════════════════════════════════════════════
//  DEBUG PANEL
// ═══════════════════════════════════════════════════════════════════════════════
if(DEBUG){
  const dp=document.createElement('div');
  Object.assign(dp.style,{
    position:'fixed',bottom:'16px',right:'16px',
    background:'rgba(0,0,0,0.55)',backdropFilter:'blur(8px)',
    border:'1px solid rgba(255,255,255,0.1)',borderRadius:'12px',
    padding:'10px 14px',fontFamily:'monospace',fontSize:'11px',
    color:'#7FA8BE',zIndex:'9999',lineHeight:'1.8',minWidth:'170px',
    pointerEvents:'none',userSelect:'none',
  });
  dp.innerHTML=
    '<div style="display:flex;justify-content:space-between;gap:20px"><span>HYPER</span><span id="dbgHyper">0.00</span></div>'+
    '<div style="display:flex;justify-content:space-between;gap:20px"><span>HUME</span><span id="dbgHume">disconnected</span></div>'+
    '<div style="display:flex;justify-content:space-between;gap:20px"><span>LAST</span><span id="dbgLast">—</span></div>';
  document.body.appendChild(dp);

  setInterval(()=>{
    const he=byId('dbgHyper'),hue=byId('dbgHume'),le=byId('dbgLast');
    if(he){
      he.textContent=debugState.hyperScore.toFixed(2);
      he.style.color=debugState.hyperScore>0.62?'#FF6B6B':'#5ED1BF';
    }
    if(hue){
      hue.textContent=debugState.humeStatus;
      hue.style.color=debugState.humeStatus==='connected' ?'#5ED1BF'
                     :debugState.humeStatus==='connecting'?'#FFD166'
                     :'#FF6B6B';
    }
    if(le){
      le.textContent=debugState.lastResponseAt===null
        ?' —'
        :((Date.now()-debugState.lastResponseAt)/1000).toFixed(1)+'s ago';
    }
  },200);
}
</script>
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/couplesbreath-web/sw.js');
  }
</script>
</body>
</html>
