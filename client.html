<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
  />
  <title>Couples Breathe</title>
  <style>
    :root{
      --bg: #0b0b0d;
      --fg: #eaeaf0;
      --muted: #a9adba;
      --accent: #3ad0ff;
      --ok: #23c55e;
      --danger: #ef4444;
      --danger-deep: #c1121f;   /* stop-sign red for overlay */
      --btn-dark: #1b1e25;
      --btn-stop: #8b2c2c;      /* solid background for STOP (not transparent) */
      --btn-text: #ffffff;
    }
    html, body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    .wrap {
      min-height: 100%;
      display: grid;
      place-items: center;
      padding: 24px;
    }
    .card {
      width: min(780px, 92vw);
      background: #111318;
      border: 1px solid #1f242e;
      border-radius: 16px;
      padding: 18px 18px 22px;
      box-shadow: 0 10px 24px rgba(0,0,0,.35);
      position: relative;
      overflow: hidden;
    }
    .row {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    .row.space {
      justify-content: space-between;
    }
    h1 {
      margin: 0;
      font-size: 18px;
      letter-spacing: .2px;
      color: var(--fg);
    }
    .muted {
      color: var(--muted);
      font-size: 13px;
    }
    .status {
      display: flex;
      gap: 12px;
      align-items: baseline;
      font-size: 13px;
      color: var(--muted);
    }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 999px;
      background: #141821;
      border: 1px solid #1f2734;
      color: #cbd5e1;
    }
    .dot {
      width: 6px; height: 6px; border-radius: 50%;
      background: #93c5fd;
    }
    .ok { background: var(--ok); }
    .danger { background: var(--danger); }

    /* buttons */
    .controls {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 16px;
    }
    .btn {
      width: 100%;
      border: 0;
      color: var(--btn-text);
      font-weight: 600;
      letter-spacing: .25px;
      padding: 14px 16px;
      border-radius: 12px;
      cursor: pointer;
      transition: transform .08s ease, box-shadow .2s ease, opacity .2s ease;
      box-shadow: 0 8px 18px rgba(0,0,0,.25);
    }
    .btn:active { transform: translateY(1px) scale(0.995); }
    .btn[disabled] { opacity: .5; cursor: not-allowed; }

    .btn-start {
      background: linear-gradient(180deg, #0ea5e9, #0284c7);
      animation: pulse 1.4s ease-in-out infinite;
    }
    .btn-stop {
      background: var(--btn-stop);    /* solid (non-transparent) */
      animation: pulse 1.4s ease-in-out infinite; /* flash same as start */
    }
    .btn-test {
      background: var(--btn-dark);
      color: var(--fg);
    }
    @keyframes pulse {
      0%,100% { box-shadow: 0 0 0 0 rgba(255,255,255,.18); }
      50%     { box-shadow: 0 0 0 8px rgba(255,255,255,.05); }
    }

    /* red “stop sign” overlay */
    .overlay {
      position: absolute;
      inset: 0;
      display: none;
      place-items: center;
      padding: 18px;
      background: rgba(193,18,31,0.94); /* stop-sign red */
      color: #fff;
      z-index: 10;
      text-align: center;
    }
    .overlay.show { display: grid; }
    .overlay-inner {
      max-width: 520px;
    }
    .overlay h2 {
      margin: 0 0 8px;
      font-size: 28px;
      line-height: 1.2;
      text-transform: none;
      letter-spacing: .2px;
    }
    .overlay p {
      margin: 0 0 16px;
      font-size: 16px;
      opacity: .95;
    }
    .countdown {
      font-variant-numeric: tabular-nums;
      font-weight: 700;
      letter-spacing: .5px;
      background: rgba(255,255,255,.18);
      padding: 6px 10px;
      border-radius: 10px;
      display: inline-block;
      margin-bottom: 12px;
    }
    .btn-dismiss {
      border: 0;
      background: #111317;
      color: #fff;
      padding: 10px 14px;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 6px 16px rgba(0,0,0,.25);
    }

    /* mini log */
    .log {
      margin-top: 14px;
      padding: 10px 12px;
      background: #0f131a;
      border: 1px solid #1b2330;
      border-radius: 12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      color: #cbd5e1;
      max-height: 32vh;
      overflow: auto;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="card">

      <!-- red stop-sign overlay -->
      <div class="overlay" id="overlay">
        <div class="overlay-inner">
          <div class="countdown" id="countdown">60s</div>
          <h2>Pause and Breathe</h2>
          <p>Slow, even breaths in and out through your nose. Let your shoulders drop. You’re okay.</p>
          <button class="btn-dismiss" id="dismissBtn">Dismiss</button>
        </div>
      </div>

      <div class="row space">
        <div>
          <h1>Couples Breathe</h1>
          <div class="status" id="status">
            <span class="pill"><span class="dot" id="dot-mode"></span> <span id="mode">mode: —</span></span>
            <span class="pill"><span class="dot ok" id="dot-status"></span> <span id="state">status: idle</span></span>
          </div>
        </div>
        <div class="muted" id="note"></div>
      </div>

      <div class="controls">
        <button class="btn btn-start" id="startBtn">Start</button>
        <button class="btn btn-stop"  id="stopBtn"  disabled>Stop</button>
      </div>

      <div class="controls" style="margin-top:8px">
        <button class="btn btn-test" id="testTrigger">Test “Pause and Breathe”</button>
      </div>

      <div class="log" id="log"></div>
    </div>
  </div>

  <script>
    // ===== config =====
    // If you're hosting frontend separately, set this to your Render proxy URL.
    // Example: const PROXY = 'wss://pause-proxy.onrender.com/client';
    const PROXY = (location.protocol.replace('http','ws') + '//' + location.host + '/client');

    // ===== el helpers =====
    const $ = (id) => document.getElementById(id);
    const elLog = $('log');
    function log(...args){ const line = args.map(a => typeof a === 'string' ? a : JSON.stringify(a)).join(' '); elLog.textContent += line + '\n'; elLog.scrollTop = elLog.scrollHeight; }

    const elMode = $('mode');
    const elState = $('state');
    const dotMode = $('dot-mode');
    const dotStatus = $('dot-status');
    const overlay = $('overlay');
    const countdown = $('countdown');
    const dismissBtn = $('dismissBtn');
    const startBtn = $('startBtn');
    const stopBtn  = $('stopBtn');
    const testBtn  = $('testTrigger');

    // ===== audio capture → base64 PCM WAV chunks (MediaRecorder Opus also works with your current proxy) =====
    let ws, mediaStream, recorder, sendTimer;
    let pausedUntil = 0;
    let countdownTimer = null;

    function setMode(text){ elMode.textContent = 'mode: ' + text; }
    function setState(text){ elState.textContent = 'status: ' + text; }

    function showOverlay(seconds=60){
      // ensure 60s from any trigger
      const now = Date.now();
      const until = now + seconds*1000;
      pausedUntil = Math.max(pausedUntil, until);

      overlay.classList.add('show');
      tickCountdown();
      if (countdownTimer) clearInterval(countdownTimer);
      countdownTimer = setInterval(tickCountdown, 250);
    }

    function hideOverlay(){
      overlay.classList.remove('show');
      pausedUntil = 0;
      if (countdownTimer) { clearInterval(countdownTimer); countdownTimer = null; }
    }

    function tickCountdown(){
      const remain = Math.max(0, pausedUntil - Date.now());
      const sec = Math.ceil(remain/1000);
      countdown.textContent = sec + 's';
      if (remain <= 0) hideOverlay();
    }

    dismissBtn.addEventListener('click', hideOverlay);

    // ===== start / stop capture =====
    async function start(){
      if (ws && ws.readyState === WebSocket.OPEN){ /* already */ } else {
        await openWS();
      }
      await startAudio();
      startBtn.disabled = true;
      stopBtn.disabled = false;
      setState('listening');
    }

    function stop(){
      try { if (recorder && recorder.state !== 'inactive') recorder.stop(); } catch{}
      try { if (mediaStream) mediaStream.getTracks().forEach(t=>t.stop()); } catch{}
      try { if (ws) ws.close(); } catch{}
      clearInterval(sendTimer);
      recorder = null; mediaStream = null; ws = null;
      startBtn.disabled = false;
      stopBtn.disabled = true;
      setState('idle');
    }

    startBtn.addEventListener('click', start);
    stopBtn.addEventListener('click', stop);

    // Demo button to simulate a trigger (for UI check)
    testBtn.addEventListener('click', () => {
      showOverlay(60);
      log('[demo] simulated trigger → Pause and Breathe (60s)');
    });

    // ===== WS handling =====
    async function openWS(){
      return new Promise((resolve, reject) => {
        ws = new WebSocket(PROXY);
        ws.onopen = () => {
          setMode('hume');
          dotMode.classList.add('ok');
          log('[ws] open →', PROXY);
          resolve();
        };
        ws.onmessage = (ev) => {
          let msg; try { msg = JSON.parse(ev.data); } catch { return; }

          if (msg.type === 'hello'){
            setMode(msg.mode || '—');
          }
          else if (msg.type === 'hume'){
            if (msg.status === 'connected') {
              dotStatus.classList.add('ok');
              setState('connected');
            } else if (msg.status === 'closed') {
              setState('closed');
            } else if (msg.status === 'error') {
              setState('error');
              log('[hume] error:', msg.message || '');
            }
          }
          else if (msg.type === 'risk'){
            // (we no longer display a hyper value in header; keep log minimal)
          }
          else if (msg.type === 'trigger' && msg.kind === 'hyper'){
            log('[trigger] hyper:', Number(msg.score || 0).toFixed(2));
            showOverlay(60); // always 60s
          }
        };
        ws.onerror = (e) => { log('[ws] error'); };
        ws.onclose = () => {
          dotStatus.classList.remove('ok');
          setState('idle');
          log('[ws] closed');
        };
      });
    }

    async function startAudio(){
      if (!navigator.mediaDevices?.getUserMedia){
        log('microphone unavailable'); return;
      }
      mediaStream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation: true, noiseSuppression: true }, video: false });

      // Use MediaRecorder; server already accepts base64 chunks
      const mr = new MediaRecorder(mediaStream, { mimeType: 'audio/webm' });
      const chunks = [];
      mr.ondataavailable = (e) => { if (e.data && e.data.size) chunks.push(e.data); };
      mr.onstop = async () => {
        if (!chunks.length) return;
        const blob = new Blob(chunks, { type: 'audio/webm' });
        chunks.length = 0;
        const b64 = await blobToBase64(blob);
        if (ws && ws.readyState === WebSocket.OPEN){
          ws.send(JSON.stringify({ type: 'audio', data_b64: b64.split(',')[1] || '' }));
          log('[client] sent wav bytes ≈', (b64.length|0));
        }
      };

      // record in small slices for low latency
      mr.start(1000); // timeslice ms
      recorder = mr;

      // safety flush every ~1s even if stop/start events lag
      sendTimer = setInterval(() => {
        if (!recorder || recorder.state !== 'recording') return;
        recorder.requestData();
      }, 1100);

      setState('listening');
    }

    function blobToBase64(blob){
      return new Promise((resolve) => {
        const r = new FileReader();
        r.onloadend = () => resolve(r.result);
        r.readAsDataURL(blob);
      });
    }

    // boot
    (function init(){
      log('ready. tap Start to begin.');
      setState('idle');
      setMode('—');
    })();
  </script>
</body>
</html>
